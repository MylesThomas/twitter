---
title: "nba-analysis"
author: "Myles Thomas"
date: "1/8/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## nba-analysis

```{r}
# Load libraries
library(tidyverse)
library(gt)
library(tidymodels)
library(ggthemes)
library(ggtext)
library(stringi)
library(gt)
library(rmarkdown)
library(rlang)
options(scipen = 99999)


# get nba data
nba_logos <- readr::read_csv("C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/a/nba-colors-logos.csv")
nba_teams <- readr::read_csv("C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/a/nba-colors-teams.csv")
headshots <- readr::read_csv("C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/a/nba-headshots.csv")

team <- readr::read_csv("../data/nba/team.csv") %>% janitor::clean_names() %>% dplyr::mutate(date = lubridate::dmy(date))
player <- readr::read_csv("../data/nba/player.csv") %>% janitor::clean_names() %>% dplyr::mutate(date = lubridate::dmy(date))

team_accurate_game_stats <- readr::read_csv("../data/nba/s3/RUNNING_Adj_full_team_stats.csv") %>%
  janitor::clean_names() %>%
  dplyr::mutate(date = lubridate::dmy(date)) %>%
  rename(points_expected = sq_points,
         points_scored = points) %>%
  mutate(points_difference = points_expected - points_scored) %>%
  filter(points_scored > 10) 

running_player <- readr::read_csv("../data/nba/s3/Running_Player_Analysis.csv") %>%
  janitor::clean_names() %>%
  dplyr::mutate(date = lubridate::dmy(date)) %>%
  mutate_at("players", Upper_Case_Names) %>%
  mutate(good_pos_rate = good_possessions / (good_possessions + bad_possessions))

t1 <- team_accurate_game_stats %>%
  arrange(game_id, teams)
t2 <- team_accurate_game_stats %>%
  arrange(game_id, dplyr::desc(teams)) %>%
  rename(opponent = teams) %>%
  select(c(opponent, points_scored, points_expected)) %>%
  rename("points_allowed" = points_scored,
         "points_allowed_expected" = points_expected)
matchups <- dplyr::bind_cols(t1, t2) %>%
  mutate(game_mov = points_scored - points_allowed) %>%
  mutate(game_mov_expected = points_expected - points_allowed_expected) %>%
  mutate(win = ifelse(game_mov > 0, 1, 0),
         win_expectation = ifelse(game_mov_expected > 0, 1, 0)) %>%
  filter(points_scored > 10) 

today <- lubridate::today()
yesterday <- today - 1
asp_ratio <- 16/9
lower_bound <- .025
upper_bound <- .975

# GT functions
gt_theme_538 <- function(data,...) {
  data %>%
  opt_all_caps() %>%
  opt_table_font(
    font = list(
      google_font("Chivo"),
      default_fonts()
    )
  ) %>%
    tab_style(
      style = cell_borders(
        sides = "bottom", color = "transparent", weight = px(2)
      ),
      locations = cells_body(
        columns = everything(),
        # This is a relatively sneaky way of changing the bottom border
        # Regardless of data size
        rows = nrow(data$`_data`)
      )
    )  %>% 
  tab_options(
    column_labels.background.color = "white",
    table.border.top.width = px(3),
    table.border.top.color = "transparent",
    table.border.bottom.color = "transparent",
    table.border.bottom.width = px(3),
    column_labels.border.top.width = px(3),
    column_labels.border.top.color = "transparent",
    column_labels.border.bottom.width = px(3),
    column_labels.border.bottom.color = "black",
    data_row.padding = px(3),
    source_notes.font.size = 12,
    table.font.size = 16,
    heading.align = "left",
    ...
  ) 
}

gt_theme_espn <- function(data, ...){
  data %>% 
    opt_all_caps()  %>%
    opt_table_font(
      font = list(
        google_font("Lato"),
        default_fonts()
      )
    )  %>% 
    opt_row_striping() %>% 
    tab_options(
      row.striping.background_color = "#fafafa",
      table_body.hlines.color = "#f6f7f7",
      source_notes.font.size = 12,
      table.font.size = 16,
      table.width = px(925),
      heading.align = "left",
      heading.title.font.size = 24,
      table.border.top.color = "transparent",
      table.border.top.width = px(3),
      data_row.padding = px(7),
      ...
    ) 
}

th <- theme_fivethirtyeight() +
  theme_classic() + 
  theme(
    plot.title = element_text(face = "bold", size = 24),
    plot.subtitle = element_text(size = 18, face = "italic"),
    plot.caption = element_markdown(size = 12, face = "italic"),
    axis.text = element_text(size = 12),
    axis.title.y = element_text(size = 12, angle = 0, vjust = .5), # vjust = location on (0, 1)
    axis.title.x = element_text(size = 12), # vjust = location on (0, 1)
    aspect.ratio = 1/asp_ratio,
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    strip.background = element_rect(color = "black", fill = "#C0C0C0", size = 3.5, linetype = "blank")
    )
```

```{r}
player ; nba_team_logos
```
Recent Games: Who is playing well, who is not

```{r}
timestamp_1 <- "2022-02-01"
timestamp_2 <- "2022-02-09"

d <- player %>% 
  filter(date >= timestamp_1 & date <= timestamp_2) %>%
  mutate(new = abs(points_difference)) %>%
  left_join(nba_logos) %>%
  filter(points_scored > 20 | points_expected > 20) %>%
  filter(points_expected > 5)
d

g <- d %>%
  arrange(desc(points_difference))

b <- d %>%
  arrange(points_difference)

g
b
```


```{r}
domain <- 15

gt <- g %>%
  slice(1:20) %>%
  select(logo, players, points_expected, points_scored, points_difference) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(logo)),
    fn = function(x) {
      web_image(
        url = x,
        height = gt::px(30))}) %>%
  cols_label(
    logo = "",
    players = "",
    points_expected = "Expected",
    points_scored = "Actual",
    points_difference = "Difference"
  ) %>%
  tab_source_note(
    source_note = md("<br>Figure: @Shot_Quality")
  )  %>%
  tab_header(title = md("**ShotQuality discrepancies by Player**"),
             subtitle = md("")) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(points_difference),
    colors = scales::col_numeric(
      domain = c(-domain, domain),
      alpha = .95,
      palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  tab_spanner(
    label = "ShotQuality Metrics",
    columns = c(points_expected:points_difference)) %>%
  tab_spanner(
    label = "Player",
    columns = c(logo:players))
gt

gt2 <- b %>%
  slice(1:20) %>%
  select(logo, players, points_expected, points_scored, points_difference) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(logo)),
    fn = function(x) {
      web_image(
        url = x,
        height = gt::px(30))}) %>%
  cols_label(
    logo = "",
    players = "",
    points_expected = "Expected",
    points_scored = "Actual",
    points_difference = "Difference"
  ) %>%
  tab_source_note(
    source_note = md(""))  %>%
  tab_header(title = md(glue::glue("Games between {timestamp_1} and {timestamp_2}")),
             subtitle = md("")) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(points_difference),
    colors = scales::col_numeric(
      domain = c(-domain, domain),
      alpha = .95,
      palette = c("#ff2700", "#f8fcf8", "#44ab43")  )) %>%
  tab_spanner(
    label = "ShotQuality Metrics",
    columns = c(points_expected:points_difference)) %>%
  tab_spanner(
    label = "Player",
    columns = c(logo:players)) %>%
    opt_table_font(font = list(default_fonts())) %>%
  tab_style(
    style = cell_borders(
      sides = "left",
      color = "black",
      weight = px(3)),
    locations = list(cells_body(columns = 1),
                     cells_column_labels(1))) %>%
    tab_options(
      column_labels.background.color = "white",
      column_labels.font.weight = "bold",
      table.border.top.width = px(3),
      table.border.top.color = "transparent",
      table.border.bottom.color = "transparent",
      table.border.bottom.width = px(3),
      column_labels.border.top.width = px(3),
      column_labels.border.top.color = "transparent",
      column_labels.border.bottom.width = px(3),
      column_labels.border.bottom.color = "black",
      data_row.padding = px(3),
      source_notes.font.size = 12,
      table.font.size = 16,
      heading.align = "right")

gt2


gt::gtsave(data = gt,
           filename = "left.png",
           path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz")

gt::gtsave(data = gt2,
           filename = "right.png",
           path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz")

img1 <- magick::image_read("C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz/left.png")
img2 <- magick::image_read("C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz/right.png")
img3 <- magick::image_append(c(img1, img2))

magick::image_write(image = img3,
                    path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz/side-to-side.png",
                    format = 'png')

knitr::include_graphics("C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz/side-to-side.png")
```



```{r}
player %>%
  arrange(desc(date))#%>%
  filter(players == "Klay Thompson") %>%
  slice(1) %>%
  select(logos, players, points_expected:points_difference, rim_fg_percent_expected:rim_fg_percent_difference, x3pt_fg_percent_expected:x3pt_fg_percent_difference, midrange_fg_percent_expected:midrange_fg_percent_difference, free_throw_percent_expected:free_throw_percent_difference, shot_attempts:free_throw_attempts)
```


```{r}
# getting quartile values for a game's outcome
lower_bound <- .10
upper_bound <- .90

quantile(team$sq_ppp, c(lower_bound))
quantile(team$sq_ppp, c(.50))
quantile(team$sq_ppp, c(upper_bound))

```

```{r}
quantile(team$free_throw_percent_expected)
quantile(team$free_throw_percent)

```



```{r}
yesterday <- lubridate::today() - 1

player %>%
  filter(date == yesterday) %>%
  mutate(new = abs(points_difference)) %>%
  arrange(desc(new))

d <- team %>%
  filter(date == yesterday) %>%
  mutate(points_difference = points_expected - points_scored,
         new = abs(points_difference)) %>%
  arrange(desc(new)) %>%
  filter(teams %in% c("Los Angeles Clippers", "Atlanta Hawks")) %>%
  left_join(nba_team_logos) %>%
  select(logo, teams,
         sq_ppp,
         points_expected, points_scored,
         x3pt_fg_percent_expected, x3pt_fg_percent,
         midrange_fg_percent_expected, midrange_fg_percent,
         free_throw_percent_expected, free_throw_percent,
         point_differential_team)

d
```


```{r}
gt1 <- d %>%
  mutate_if(is.numeric, function(x) {round(x, 2)}) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(logo)),
    fn = function(x) {
      web_image(url = x, height = gt::px(30))}) %>%
  cols_label(logo="", 
             teams="",
              sq_ppp="SQ PPP", 
              points_expected="Points Exp.", 
              points_scored="Points", 
              x3pt_fg_percent_expected = "3P% Exp.",
              x3pt_fg_percent = "3P%",
              midrange_fg_percent_expected = "Midrange FG% Exp.",
              midrange_fg_percent = "Midrange FG%",
              free_throw_percent_expected = "FT% Exp.",
              free_throw_percent = "FT%",
              point_differential_team = "Team Point Differential") %>%
  tab_source_note(source_note = md("<br>Figure: @Shot_Quality"))  %>%
  tab_header(title = md("**Clippers win the game, Hawks dominate the ShotQuality**"),
             subtitle = md("1/9/2022")) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(sq_ppp),
    colors = scales::col_numeric(domain = c(quantile(team$sq_ppp, c(lower_bound)), 
                                            quantile(team$sq_ppp, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(points_expected),
    colors = scales::col_numeric(domain = c(quantile(team$points_expected, c(lower_bound)), 
                                            quantile(team$points_expected, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(points_scored),
    colors = scales::col_numeric(domain = c(quantile(team$points_scored, c(lower_bound)), 
                                            quantile(team$points_scored, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(x3pt_fg_percent_expected),
    colors = scales::col_numeric(domain = c(quantile(team$x3pt_fg_percent_expected, c(lower_bound)), 
                                            quantile(team$x3pt_fg_percent_expected, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(x3pt_fg_percent),
    colors = scales::col_numeric(domain = c(quantile(team$x3pt_fg_percent, c(lower_bound)), 
                                            quantile(team$x3pt_fg_percent, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(midrange_fg_percent_expected),
    colors = scales::col_numeric(domain = c(quantile(team$midrange_fg_percent_expected, c(lower_bound)), 
                                            quantile(team$midrange_fg_percent_expected, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(midrange_fg_percent),
    colors = scales::col_numeric(domain = c(quantile(team$midrange_fg_percent, c(lower_bound)),
                                            quantile(team$midrange_fg_percent, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(free_throw_percent_expected),
    colors = scales::col_numeric(domain = c(.60, .90),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(free_throw_percent),
    colors = scales::col_numeric(domain = c(quantile(team$free_throw_percent, c(lower_bound)),
                                            quantile(team$free_throw_percent, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(point_differential_team),
    colors = scales::col_numeric(domain = c(quantile(team$point_differential_team, c(lower_bound)),
                                            quantile(team$point_differential_team, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  tab_spanner(
    label = "ShotQuality Metrics",
    columns = c(sq_ppp:point_differential_team)
  ) %>%
  tab_spanner(
    label = "Team",
    columns = c(logo:teams)
  )


gt1
```




```{r}
gt2 <- d %>%
  mutate_if(is.numeric, function(x) {round(x, 2)}) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(logo)),
    fn = function(x) {
      web_image(url = x, height = gt::px(30))}) %>%
  cols_label(logo="", 
             teams="",
              sq_ppp="SQ PPP", 
              points_expected="Points Exp.", 
              points_scored="Points", 
              x3pt_fg_percent_expected = "3P% Exp.",
              x3pt_fg_percent = "3P%",
              midrange_fg_percent_expected = "Midrange FG% Exp.",
              midrange_fg_percent = "Midrange FG%",
              free_throw_percent_expected = "FT% Exp.",
              free_throw_percent = "FT%",
              point_differential_team = "Team Point Differential") %>%
  tab_source_note(source_note = md("<br>Figure: @Shot_Quality"))  %>%
  tab_header(title = md("**Clippers win the game, Hawks dominate the ShotQuality**"),
             subtitle = md("1/9/2022")) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(sq_ppp),
    colors = scales::col_numeric(domain = c(quantile(team$sq_ppp, c(lower_bound)), 
                                            quantile(team$sq_ppp, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(points_scored),
    colors = scales::col_numeric(domain = c(quantile(team$points_scored, c(lower_bound)), 
                                            quantile(team$points_scored, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(x3pt_fg_percent),
    colors = scales::col_numeric(domain = c(quantile(team$x3pt_fg_percent, c(lower_bound)), 
                                            quantile(team$x3pt_fg_percent, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(midrange_fg_percent),
    colors = scales::col_numeric(domain = c(quantile(team$midrange_fg_percent, c(lower_bound)),
                                            quantile(team$midrange_fg_percent, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(free_throw_percent),
    colors = scales::col_numeric(domain = c(quantile(team$free_throw_percent, c(lower_bound)),
                                            quantile(team$free_throw_percent, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(point_differential_team),
    colors = scales::col_numeric(domain = c(quantile(team$point_differential_team, c(lower_bound)),
                                            quantile(team$point_differential_team, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  tab_spanner(
    label = "ShotQuality Metrics",
    columns = c(sq_ppp:point_differential_team)
  ) %>%
  tab_spanner(
    label = "Team",
    columns = c(logo:teams)
  )


gt2

 
```


```{r}
gt3 <- d %>%
  mutate_if(is.numeric, function(x) {round(x, 2)}) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(logo)),
    fn = function(x) {
      web_image(url = x, height = gt::px(30))}) %>%
  cols_label(logo="", 
             teams="",
              sq_ppp="SQ PPP", 
              points_expected="Points Exp.", 
              points_scored="Points", 
              x3pt_fg_percent_expected = "3P% Exp.",
              x3pt_fg_percent = "3P%",
              midrange_fg_percent_expected = "Midrange FG% Exp.",
              midrange_fg_percent = "Midrange FG%",
              free_throw_percent_expected = "FT% Exp.",
              free_throw_percent = "FT%",
              point_differential_team = "Team Point Differential") %>%
  tab_source_note(source_note = md("<br>Figure: @Shot_Quality"))  %>%
  tab_header(title = md("**Clippers win the game, Hawks dominate the ShotQuality**"),
             subtitle = md("1/9/2022")) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(sq_ppp),
    colors = scales::col_numeric(domain = c(quantile(team$sq_ppp, c(lower_bound)), 
                                            quantile(team$sq_ppp, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(points_expected),
    colors = scales::col_numeric(domain = c(quantile(team$points_expected, c(lower_bound)), 
                                            quantile(team$points_expected, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(x3pt_fg_percent_expected),
    colors = scales::col_numeric(domain = c(quantile(team$x3pt_fg_percent_expected, c(lower_bound)), 
                                            quantile(team$x3pt_fg_percent_expected, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(midrange_fg_percent_expected),
    colors = scales::col_numeric(domain = c(quantile(team$midrange_fg_percent_expected, c(lower_bound)), 
                                            quantile(team$midrange_fg_percent_expected, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(free_throw_percent_expected),
    colors = scales::col_numeric(domain = c(.60, .90),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(point_differential_team),
    colors = scales::col_numeric(domain = c(quantile(team$point_differential_team, c(lower_bound)),
                                            quantile(team$point_differential_team, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  tab_spanner(
    label = "ShotQuality Metrics",
    columns = c(sq_ppp:point_differential_team)
  ) %>%
  tab_spanner(
    label = "Team",
    columns = c(logo:teams)
  )


gt3
```



```{r}
gt::gtsave(data = gt1,
           filename = "clips-hawks-diffs.png",
           path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz")
```


```{r}
gt <- d %>%
  mutate_if(is.numeric, function(x) {round(x, 2)}) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(logo)),
    fn = function(x) {
      web_image(url = x, height = gt::px(30))}) %>%
  cols_label(logo="", 
             teams="",
              sq_ppp="SQ PPP", 
              points_expected="Points Exp.", 
              points_scored="Points", 
              x3pt_fg_percent_expected = "3P% Exp.",
              x3pt_fg_percent = "3P%",
              midrange_fg_percent_expected = "Midrange FG% Exp.",
              midrange_fg_percent = "Midrange FG%",
              free_throw_percent_expected = "FT% Exp.",
              free_throw_percent = "FT%",
              point_differential_team = "Team Point Differential") %>%
  tab_source_note(source_note = md("<br>Figure: @Shot_Quality"))  %>%
  tab_header(title = md("**Statistics from each team's most recent game**"),
             subtitle = md("Warriors at Bucks, 1/13/2022")) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(sq_ppp),
    colors = scales::col_numeric(domain = c(quantile(team$sq_ppp, c(lower_bound)), 
                                            quantile(team$sq_ppp, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(points_expected),
    colors = scales::col_numeric(domain = c(quantile(team$points_expected, c(lower_bound)), 
                                            quantile(team$points_expected, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(points_scored),
    colors = scales::col_numeric(domain = c(quantile(team$points_scored, c(lower_bound)), 
                                            quantile(team$points_scored, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(x3pt_fg_percent_expected),
    colors = scales::col_numeric(domain = c(quantile(team$x3pt_fg_percent_expected, c(lower_bound)), 
                                            quantile(team$x3pt_fg_percent_expected, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(x3pt_fg_percent),
    colors = scales::col_numeric(domain = c(.1, .6),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(midrange_fg_percent_expected),
    colors = scales::col_numeric(domain = c(quantile(team$midrange_fg_percent_expected, c(lower_bound)), 
                                            quantile(team$midrange_fg_percent_expected, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(midrange_fg_percent),
    colors = scales::col_numeric(domain = c(quantile(team$midrange_fg_percent, c(lower_bound)),
                                            quantile(team$midrange_fg_percent, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(free_throw_percent_expected),
    colors = scales::col_numeric(domain = c(.60, .90),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(free_throw_percent),
    colors = scales::col_numeric(domain = c(quantile(team$free_throw_percent, c(lower_bound)),
                                            quantile(team$free_throw_percent, c(upper_bound))),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  data_color(
    columns = c(point_differential_team),
    colors = scales::col_numeric(domain = c(-20, 20),
                                 alpha = .95, palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  tab_spanner(
    label = "ShotQuality Metrics",
    columns = c(sq_ppp:point_differential_team)
  ) %>%
  tab_spanner(
    label = "Team",
    columns = c(logo:teams)
  )

gt

gt::gtsave(data = gt,
           filename = "bucks-warriors-last-game.png",
           path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz")
```


```{r}
d <- player %>%
  filter(date == yesterday) %>%
  mutate(new = abs(points_difference)) %>%
  arrange(desc(new)) %>%
  filter(points_expected > 10) %>%
  arrange(points_difference) %>%
  slice(1:15) %>%
  left_join(nba_team_logos, by = c("logos" = "teams")) %>%
  left_join(headshots)

#d[2, 56] <- "https://s3-us-west-2.amazonaws.com/static.fantasydata.com/headshots/nba/low-res/20001458.png"

d
```



Players most above/below:


```{r}
player
d <- player %>%
  # Filter by last month
  filter(date >= "2022-01-01") %>%
  group_by(players) %>%
  summarise(o1 = mean(points_expected),
            o2 = mean(points_scored),
            o3 = mean(points_difference)) %>%
  rename(points_expected = o1,
         points_scored = o2,
         points_difference = o3)

d
```

Fix names that didn't get joined on bc name issues:

```{r}
headshots %>%
  arrange(players)
```


```{r}
# FIX:

# Copy/Paste the INCORRECT players names from down below who have NA in columns after the join
old_list <- c("Fred Vanvleet", "Lamelo Ball", "Cameron Reddish", "Demar Derozan",
           "Marcus Morris Sr", "Zach Lavine", "Caris Levert", "Rj Barrett")

# Find players CORRECT name/spelling in excel file, or from code chunk above this, copy paste that in here
new_list <- c("Fred VanVleet", "LaMelo Ball", "Cam Reddish", "DeMar DeRozan",
              "Marcus Morris Sr.", "Zach LaVine", "Caris LeVert", "RJ Barrett")

d[d$players %in% old_list, "players"] <- new_list

# Re-run code before proceeding (this should be empty)
d[d$players %in% old_list, ]
```

```{r}
######## Look at these print outs, go back up and fix names that are off ########
g <- d %>%
  arrange(desc(points_difference)) %>%
  filter(points_scored > 10) %>%
  slice(1:20) %>%
  left_join(headshots)

b <- d %>%
  arrange(points_difference) %>%
  filter(points_expected > 10) %>%
  slice(1:20) %>%
  left_join(headshots)

g
b
```



```{r}
domain <- 7.5

gt <- g %>%
  select(headshot, players, points_expected, points_scored, points_difference) %>%
  mutate_if(is.numeric, function(x) {round(x, 2)}) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(headshot)),
    fn = function(x) {
      web_image(url = x, height = gt::px(30))}) %>%
  cols_label(
    headshot = "",
    players = "",
    points_expected = "Expected",
    points_scored = "Scored",
    points_difference = "Difference"
  ) %>%
  tab_source_note(
    source_note = md("<br>Figure: @Shot_Quality")
  )  %>%
  tab_header(title = md("**ShotQuality discrepancies by Player**"),
             subtitle = md("")) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(points_difference),
    colors = scales::col_numeric(
      domain = c(-domain, domain),
      alpha = .95,
      palette = c("#ff2700", "#f8fcf8", "#44ab43")  
    )) %>%
  tab_spanner(
    label = "ShotQuality Metrics",
    columns = c(points_expected:points_difference)
  ) %>%
  tab_spanner(
    label = "Player",
    columns = c(headshot:players)
  )

gt

gt2 <- b %>%
  select(headshot, players, points_expected, points_scored, points_difference) %>%
  mutate_if(is.numeric, function(x) {round(x, 2)}) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(headshot)),
    fn = function(x) {
      web_image(url = x, height = gt::px(30))}) %>%
  cols_label(
    headshot = "",
    players = "",
    points_expected = "Expected",
    points_scored = "Scored",
    points_difference = "Difference"
  ) %>%
  tab_source_note(
    source_note = md("")
  )  %>%
  tab_header(title = md(glue::glue("PPG, January 2022")), # Games played on {format(yesterday, '%m-%d-%y')}
             subtitle = md("")) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(points_difference),
    colors = scales::col_numeric(
      domain = c(-domain, domain),
      alpha = .95,
      palette = c("#ff2700", "#f8fcf8", "#44ab43")  
    )) %>%
  tab_spanner(
    label = "ShotQuality Metrics",
    columns = c(points_expected:points_difference)
  ) %>%
  tab_spanner(
    label = "Player",
    columns = c(headshot:players)
  ) %>%
    opt_table_font(font = list(default_fonts())) %>%
  tab_style(
    style = cell_borders(
      sides = "left",
      color = "black",
      weight = px(3)),
    locations = list(cells_body(columns = 1),
                     cells_column_labels(1))) %>%
    tab_options(
      column_labels.background.color = "white",
      column_labels.font.weight = "bold",
      table.border.top.width = px(3),
      table.border.top.color = "transparent",
      table.border.bottom.color = "transparent",
      table.border.bottom.width = px(3),
      column_labels.border.top.width = px(3),
      column_labels.border.top.color = "transparent",
      column_labels.border.bottom.width = px(3),
      column_labels.border.bottom.color = "black",
      data_row.padding = px(3),
      source_notes.font.size = 12,
      table.font.size = 16,
      heading.align = "right"
    )

gt2

gt::gtsave(data = gt,
           filename = "left.png",
           path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz")

gt::gtsave(data = gt2,
           filename = "right.png",
           path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz")

img1 <- magick::image_read("C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz/left.png")
img2 <- magick::image_read("C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz/right.png")
img3 <- magick::image_append(c(img1, img2))

magick::image_write(image = img3,
                    path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz/nba-players-season-side-to-side.png",
                    format = 'png')

knitr::include_graphics("C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz/nba-players-season-side-to-side.png")
```


```{r}
t1 <- team %>%
  select(teams, game_id) %>%
  arrange(game_id, desc(teams)) %>%
  dplyr::slice(seq(1, 100000, 2))
t2 <- team %>%
  select(teams, game_id) %>%
  arrange(game_id, teams) %>%
  dplyr::slice(seq(1, 100000, 2))
t1;t2
t3 <- dplyr::full_join(t1, t2, by = c("game_id"))

d <- running_player %>%
  arrange(desc(good_possessions)) %>%
  left_join(t3) %>%
  mutate(opponent = case_when(logos == teams.x ~ teams.y,
                              logos == teams.y ~ teams.x,
                              TRUE ~ as.character("error, error"))) %>%
  left_join(nba_logos) %>%
  left_join(headshots)

d
```


```{r}
domain1 <- c(quantile(running_player$good_pos_rate, .05, na.rm = T),
             quantile(running_player$good_pos_rate, .95, na.rm = T))

gt <- d %>%
  mutate_if(is.numeric, function(x) {round(x, 2)}) %>%
  select(headshot, players, date, opponent, good_possessions, points, sq_points, sq_passing_points_created, good_pos_rate) %>%
  dplyr::slice(1:20) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(headshot)),
    fn = function(x) {
      web_image(url = x, height = gt::px(30))}) %>%
  cols_label(
    headshot = "",
    players = "",
    date = "Date",
    opponent = "Opponent",
    good_possessions = "# 'Good' Possessions",
    points = " Actual Points",
    sq_points = "Expected Points",
    sq_passing_points_created = "SQ Points Created",
    good_pos_rate = "Good Possession Rate"
  ) %>%
  tab_source_note(
    source_note = md("<br>Figure: @Shot_Quality")
  )  %>%
  tab_header(title = md("**Who has dominated games with the highest number of Quality Possessions?**"),
             subtitle = md(glue::glue("2021-2022 Season"))) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(good_pos_rate),
    colors = scales::col_numeric(
      domain = domain1,
      palette = c("#ff2700", "#f8fcf8", "#44ab43")  
    )) %>%
  tab_spanner(
    label = "Player",
    columns = c(headshot:opponent)) %>%
  tab_spanner(
    label = "ShotQuality Metrics",
    columns = c(good_possessions:good_pos_rate)) %>%
  # Fixing column widths
  cols_width(
    headshot ~ gt::px(40),
    players ~ gt::px(190),
    date ~ gt::px(115),
    opponent ~ gt::px(170),
    good_possessions ~ gt::px(105),
    good_pos_rate ~ gt::px(130),
    gt::everything() ~ gt::px(75)
  ) %>%
  # Fixing column names to be 'centered'
  cols_align(
  align = c("center"), columns = everything()) %>%
  # Format percents for the rate stat
  gt::fmt_percent(
  columns = good_pos_rate,
  rows = everything(),
  decimals = 1) %>%
  # Make each row the same height
  tab_options(data_row.padding = gt::px(4))

gt

gt::gtsave(data = gt,
           filename = "nba-quality-of-possessions-all-season.png",
           path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz")
```


Celtics kill 76ers and hold Embiid to worst game:

```{r}
team1 <- "Boston Celtics"
team2 <- "Philadelphia 76ers"
teams <- c(team1, team2)

d <- running_player %>%
  filter(date == "2022-02-15") %>%
  filter(logos %in% teams) %>%
  left_join(nba_logos) %>%
  arrange(desc(points)) %>%
  slice(1:16)

d

gt <- d %>%
  mutate_if(is.numeric, function(x) {round(x, 2)}) %>%
  select(logo, players, good_possessions, points, sq_points, sq_passing_points_created, good_pos_rate) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(logo)),
    fn = function(x) {
      web_image(url = x, height = gt::px(30))}) %>%
  cols_label(
    logo = "",
    players = "",
    good_possessions = "# 'Good' Possessions",
    points = " Actual Points",
    sq_points = "Expected Points",
    sq_passing_points_created = "SQ Points Created",
    good_pos_rate = "Good Possession Rate"
  ) %>%
  tab_source_note(
    source_note = md("<br>Figure: @Shot_Quality")
  )  %>%
  tab_header(title = md(glue::glue("{team1} vs. {team2}, {today}")),
             subtitle = md(glue::glue(""))) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(good_pos_rate),
    colors = scales::col_numeric(
      domain = c(0, 1),
      palette = c("#ff2700", "#f8fcf8", "#44ab43"))) %>%
  tab_spanner(
    label = "Player",
    columns = c(logo:players)) %>%
  tab_spanner(
    label = "ShotQuality Metrics",
    columns = c(good_possessions:good_pos_rate)) %>%
  # Fixing column widths
  cols_width(
    logo ~ gt::px(40),
    players ~ gt::px(190),
    good_possessions ~ gt::px(105),
    good_pos_rate ~ gt::px(130),
    gt::everything() ~ gt::px(75)
  ) %>%
  # Fixing column names to be 'centered'
  cols_align(
  align = c("center"), columns = everything()) %>%
  # Format percents for the rate stat
  gt::fmt_percent(
  columns = good_pos_rate,
  rows = everything(),
  decimals = 1) %>%
  # Make each row the same height
  tab_options(data_row.padding = gt::px(4))

gt

gt::gtsave(data = gt,
           filename = "a.png",
           path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz")

```

Top games for sq passing points

```{r}
d <- running_player %>%
  arrange(desc(sq_passing_points_created)) %>%
  left_join(nba_logos) %>%
  left_join(headshots) %>%
  slice(1:20)

d
```


```{r}
domain1 <- c(quantile(running_player$good_pos_rate, .05, na.rm = T),
             quantile(running_player$good_pos_rate, .95, na.rm = T))

domain2 <- c(10, max(running_player$sq_passing_points_created))

gt <- d %>%
  #mutate_at(c("sq_ppp", "sq_points"), function(x) {round(x, 2)}) %>%
  select(headshot, players, date, possessions, points, sq_points, sq_ppp, sq_passing_points_created,  good_pos_rate) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(headshot)),
    fn = function(x) {
      web_image(url = x, height = gt::px(30))}) %>%
  cols_label(
    headshot = "",
    players = "",
    date = "",
    points = " Actual Points",
    sq_points = "Expected Points",
    possessions = "Possessions",
    sq_passing_points_created = "SQ Passing Points",
    good_pos_rate = "Good Possession Rate",
    sq_ppp = "SQ PPP"
  ) %>%
  tab_source_note(
    source_note = md("<br>Figure: @Shot_Quality")
  )  %>%
  tab_header(title = md("**Individual Performances with the most Expected Points Created**"),
             subtitle = md(glue::glue("2021-2022 Season"))) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(good_pos_rate),
    colors = scales::col_numeric(
      domain = domain1,
      palette = c("#ff2700", "#f8fcf8", "#44ab43")  
    )) %>%
  data_color(
    columns = c(sq_passing_points_created),
    colors = scales::col_numeric(
      domain = c(domain2),
      palette = c("#ff2700", "#f8fcf8", "#44ab43")  
    )) %>%
  
  tab_spanner(
    label = "ShotQuality Metrics",
    columns = c(possessions:good_pos_rate)) %>%
  tab_spanner(
    label = "Player",
    columns = c(headshot:date)) %>%
  # Fixing column widths
  cols_width(
    players ~ gt::px(130),
    possessions ~ gt::px(115),
    headshot ~ gt::px(40),
    date ~ gt::px(120),
    good_pos_rate ~ gt::px(130),
    gt::everything() ~ gt::px(75)
  ) %>%
  # Fixing column names to be 'centered'
  cols_align(
  align = c("center"), columns = everything()) %>%
  # Format percents for the rate stat
  gt::fmt_percent(
  columns = good_pos_rate,
  rows = everything(),
  decimals = 1) %>%
  # Make each row the same height
  tab_options(data_row.padding = gt::px(4))

gt

gt::gtsave(data = gt,
           filename = "a2.png",
           path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz")
```


Mavs 26-8 in last 34



```{r}
d <-
  matchups %>%
  group_by(teams) %>%
  mutate(game_num = dplyr::row_number()) %>%
  ungroup() %>%
  left_join(nba_teams) %>%
  mutate(g = ifelse(game_num <= 35, "First 35 Games", "Since Then"))

d

sum_df <- d %>%
  group_by(teams, g, logo) %>%
  summarise(mean_sq_ppp = mean(sq_ppp),
            
            mean_sq_points = mean(points_expected),
            mean_actual_points = mean(points_scored),
            
            mean_points_diff_pg = mean(points_expected) - mean(points_scored),
            
            wins = sum(win),
            wins_p = mean(win),
            wins_expected = sum(win_expectation),
            wins_p_expected = mean(win_expectation),
            game_mov_mean = mean(game_mov),
            .groups = "drop"
            ) %>%
  tidyr::pivot_wider(names_from = "g", values_from = c(mean_sq_ppp:game_mov_mean)) %>%
  janitor::clean_names() 

d2 <- sum_df %>%
  mutate(mean_sq_ppp_diff = mean_sq_ppp_since_then - mean_sq_ppp_first_35_games,
         mean_sq_points_diff = mean_sq_points_since_then - mean_sq_points_first_35_games,
         mean_actual_points_diff = mean_actual_points_since_then - mean_actual_points_first_35_games,
         wins_diff = wins_since_then - wins_first_35_games,
         wins_p_diff = wins_p_since_then - wins_p_first_35_games,
         wins_expected_diff = wins_expected_since_then - wins_expected_first_35_games,
         game_mov_mean_diff = game_mov_mean_since_then - game_mov_mean_first_35_games
  
         ) %>%
  arrange(-wins_p_diff)

d3 <- 
  d2 %>%
  left_join(nba_teams) %>%
  select(logo, teams, mean_points_diff_pg_first_35_games, wins_p_first_35_games, wins_p_since_then) %>%
  arrange(-mean_points_diff_pg_first_35_games) %>%
  mutate(wins_p_diff = wins_p_since_then - wins_p_first_35_games) %>%
  filter(mean_points_diff_pg_first_35_games > 0) %>%
  filter(wins_p_diff > -.10)

d3

gt <- d3 %>%
  mutate_if(is.numeric, function(x) round(x, 3)) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(logo)),
    fn = function(x) {
      web_image(url = x, height = gt::px(30))}) %>%
  cols_label(
    logo = "",
    teams = "",
    mean_points_diff_pg_first_35_games = "",
    wins_p_first_35_games = "First 35",
    wins_p_since_then = "Since",
    wins_p_diff = "Difference"
  ) %>%
  tab_source_note(
    source_note = md("<br>Figure: @Shot_Quality")
  )  %>%
  tab_header(title = md("**Teams due for most positive regression after 35 games - How did they perform after?**"),
             subtitle = md(glue::glue("2021-2022 Season"))) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(mean_points_diff_pg_first_35_games),
    colors = scales::col_numeric(
      domain = c(-5, 5),
      palette = c("#ff2700", "#f8fcf8", "#44ab43")  
    )) %>%
  data_color(
    columns = c(wins_p_diff),
    colors = scales::col_numeric(
      domain = c(-0.5, 0.5),
      palette = c("#ff2700", "#f8fcf8", "#44ab43")  
    )) %>%
  tab_spanner(
    label = "Team",
    columns = c(logo:teams)) %>%
  tab_spanner(
    label = "Avg. PPG Due",
    columns = c(mean_points_diff_pg_first_35_games)) %>%
  tab_spanner(
    label = "Team Performance (Win %)",
    columns = c(wins_p_first_35_games:wins_p_diff)) %>%
  # Fixing column names to be 'centered'
  cols_align(
  align = c("center"), columns = everything()) %>%
  # Format percents for the rate stat
  gt::fmt_percent(
  columns = c(wins_p_first_35_games, wins_p_since_then, wins_p_diff),
  rows = everything(),
  decimals = 1) %>%
  # Make each row the same height
  tab_options(data_row.padding = gt::px(4))

gt

gt::gtsave(data = gt,
           filename = "1.png",
           path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz")
```


Wouldn't post double sided graphic:
```{r}
d <-
  matchups %>%
  group_by(teams) %>%
  mutate(game_num = dplyr::row_number()) %>%
  ungroup() %>%
  left_join(nba_teams) %>%
  mutate(g = ifelse(game_num <= 35, "First 35 Games", "Since Then"))

d

sum_df <- d %>%
  group_by(teams, g, logo) %>%
  summarise(mean_sq_ppp = mean(sq_ppp),
            mean_sq_points = mean(points_expected),
            mean_actual_points = mean(points_scored),
            wins = sum(win),
            wins_p = mean(win),
            wins_expected = sum(win_expectation),
            wins_p_expected = mean(win_expectation),
            game_mov_mean = mean(game_mov),
            .groups = "drop"
            ) %>%
  tidyr::pivot_wider(names_from = "g", values_from = c(mean_sq_ppp:game_mov_mean)) %>%
  janitor::clean_names() 

d2 <- sum_df %>%
  mutate(mean_sq_ppp_diff = mean_sq_ppp_since_then - mean_sq_ppp_first_35_games,
         mean_sq_points_diff = mean_sq_points_since_then - mean_sq_points_first_35_games,
         mean_actual_points_diff = mean_actual_points_since_then - mean_actual_points_first_35_games,
         wins_diff = wins_since_then - wins_first_35_games,
         wins_p_diff = wins_p_since_then - wins_p_first_35_games,
         wins_expected_diff = wins_expected_since_then - wins_expected_first_35_games,
         game_mov_mean_diff = game_mov_mean_since_then - game_mov_mean_first_35_games
  
         ) %>%
  arrange(-wins_p_diff)

d2
```


```{r}
gt <- d2 %>%
  select(logo, teams, mean_sq_ppp_first_35_games, mean_sq_ppp_since_then, mean_sq_ppp_diff, wins_p_first_35_games, wins_p_since_then, wins_p_diff) %>%
  mutate_if(is.numeric, function(x) round(x, 3)) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(logo)),
    fn = function(x) {
      web_image(url = x, height = gt::px(30))}) %>%
  cols_label(
    logo = "",
    teams = "",
    mean_sq_ppp_first_35_games = "First 35",
    mean_sq_ppp_since_then = "Since",
    mean_sq_ppp_diff = "Difference",
    wins_p_first_35_games = "First 35",
    wins_p_since_then = "Since",
    wins_p_diff = "Difference"
  ) %>%
  tab_source_note(
    source_note = md("<br>Figure: @Shot_Quality")
  )  %>%
  tab_header(title = md("**Teams Performance in 1st 35 Games vs. Rest of Season**"),
             subtitle = md(glue::glue("2021-2022 Season"))) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(mean_sq_ppp_diff),
    colors = scales::col_numeric(
      domain = c(-0.1, 0.1),
      palette = c("#ff2700", "#f8fcf8", "#44ab43")  
    )) %>%
  data_color(
    columns = c(wins_p_diff),
    colors = scales::col_numeric(
      domain = c(-0.5, 0.5),
      palette = c("#ff2700", "#f8fcf8", "#44ab43")  
    )) %>%
  tab_spanner(
    label = "Team",
    columns = c(logo:teams)) %>%
  tab_spanner(
    label = "Mean ShotQuality PPP",
    columns = c(mean_sq_ppp_first_35_games:mean_sq_ppp_diff)) %>%
  tab_spanner(
    label = "Win %",
    columns = c(wins_p_first_35_games:wins_p_diff)) %>%
  # Fixing column names to be 'centered'
  cols_align(
  align = c("center"), columns = everything()) %>%
  # Format percents for the rate stat
  gt::fmt_percent(
  columns = c(wins_p_first_35_games, wins_p_since_then, wins_p_diff),
  rows = everything(),
  decimals = 1) %>%
  # Make each row the same height
  tab_options(data_row.padding = gt::px(4))

gt

gt::gtsave(data = gt,
           filename = "1.png",
           path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz")
```


Side by side:
```{r}
gt2 <- d2 %>%
  select(logo, teams, mean_sq_ppp_first_35_games, mean_sq_ppp_since_then, mean_sq_ppp_diff, wins_p_first_35_games, wins_p_since_then, wins_p_diff) %>%
  mutate_if(is.numeric, function(x) round(x, 3)) %>%
  slice(1:15) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(logo)),
    fn = function(x) {
      web_image(url = x, height = gt::px(30))}) %>%
  cols_label(
    logo = "",
    teams = "",
    mean_sq_ppp_first_35_games = "First 35",
    mean_sq_ppp_since_then = "Since",
    mean_sq_ppp_diff = "Difference",
    wins_p_first_35_games = "First 35",
    wins_p_since_then = "Since",
    wins_p_diff = "Difference"
  ) %>%
  tab_source_note(
    source_note = md("")
  )  %>%
  tab_header(title = md("**Teams Performance in 1st 35 Games vs. Rest of Season**"),
             subtitle = md(glue::glue(""))) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(mean_sq_ppp_diff),
    colors = scales::col_numeric(
      domain = c(-0.1, 0.1),
      palette = c("#ff2700", "#f8fcf8", "#44ab43")  
    )) %>%
  data_color(
    columns = c(wins_p_diff),
    colors = scales::col_numeric(
      domain = c(-0.5, 0.5),
      palette = c("#ff2700", "#f8fcf8", "#44ab43")  
    )) %>%
  tab_spanner(
    label = "Team",
    columns = c(logo:teams)) %>%
  tab_spanner(
    label = "Mean ShotQuality PPP",
    columns = c(mean_sq_ppp_first_35_games:mean_sq_ppp_diff)) %>%
  tab_spanner(
    label = "Win %",
    columns = c(wins_p_first_35_games:wins_p_diff)) %>%
  # Fixing column names to be 'centered'
  cols_align(
  align = c("center"), columns = everything()) %>%
  # Format percents for the rate stat
  gt::fmt_percent(
  columns = c(wins_p_first_35_games, wins_p_since_then, wins_p_diff),
  rows = everything(),
  decimals = 1) %>%
  # Make each row the same height
  tab_options(data_row.padding = gt::px(4))

gt2

gt::gtsave(data = gt2,
           filename = "left.png",
           path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz")

gt3 <- d2 %>%
  select(logo, teams, mean_sq_ppp_first_35_games, mean_sq_ppp_since_then, mean_sq_ppp_diff, wins_p_first_35_games, wins_p_since_then, wins_p_diff) %>%
  mutate_if(is.numeric, function(x) round(x, 3)) %>%
  arrange(wins_p_diff) %>%
  slice(1:15) %>%
  gt() %>%
  text_transform(
    locations = cells_body(c(logo)),
    fn = function(x) {
      web_image(url = x, height = gt::px(30))}) %>%
  cols_label(
    logo = "",
    teams = "",
    mean_sq_ppp_first_35_games = "First 35",
    mean_sq_ppp_since_then = "Since",
    mean_sq_ppp_diff = "Difference",
    wins_p_first_35_games = "First 35",
    wins_p_since_then = "Since",
    wins_p_diff = "Difference"
  ) %>%
  tab_source_note(
    source_note = md("<br>Figure: @Shot_Quality")
  )  %>%
  tab_header(title = md("**2021-2022 Season**"),
             subtitle = md(glue::glue(""))) %>%
  gt_theme_538() %>%
  data_color(
    columns = c(mean_sq_ppp_diff),
    colors = scales::col_numeric(
      domain = c(-0.1, 0.1),
      palette = c("#ff2700", "#f8fcf8", "#44ab43")  
    )) %>%
  data_color(
    columns = c(wins_p_diff),
    colors = scales::col_numeric(
      domain = c(-0.5, 0.5),
      palette = c("#ff2700", "#f8fcf8", "#44ab43")  
    )) %>%
  tab_spanner(
    label = "Team",
    columns = c(logo:teams)) %>%
  tab_spanner(
    label = "Mean ShotQuality PPP",
    columns = c(mean_sq_ppp_first_35_games:mean_sq_ppp_diff)) %>%
  tab_spanner(
    label = "Win %",
    columns = c(wins_p_first_35_games:wins_p_diff)) %>%
  # Fixing column names to be 'centered'
  cols_align(
  align = c("center"), columns = everything()) %>%
  # Format percents for the rate stat
  gt::fmt_percent(
  columns = c(wins_p_first_35_games, wins_p_since_then, wins_p_diff),
  rows = everything(),
  decimals = 1) %>%
  # Make each row the same height
  tab_options(data_row.padding = gt::px(4)) %>%
    opt_table_font(font = list(default_fonts())) %>%
  tab_style(
    style = cell_borders(
      sides = "left",
      color = "black",
      weight = px(3)),
    locations = list(cells_body(columns = 1),
                     cells_column_labels(1))) %>%
    tab_options(
      column_labels.background.color = "white",
      column_labels.font.weight = "bold",
      table.border.top.width = px(3),
      table.border.top.color = "transparent",
      table.border.bottom.color = "transparent",
      table.border.bottom.width = px(3),
      column_labels.border.top.width = px(3),
      column_labels.border.top.color = "transparent",
      column_labels.border.bottom.width = px(3),
      column_labels.border.bottom.color = "black",
      data_row.padding = px(3),
      source_notes.font.size = 12,
      table.font.size = 16,
      heading.align = "right"
    )

gt3

gt::gtsave(data = gt3,
           filename = "right.png",
           path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz")


img1 <- magick::image_read("C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz/left.png")
img2 <- magick::image_read("C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz/right.png")
img3 <- magick::image_append(c(img1, img2))

magick::image_write(image = img3,
                    path = "C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz/4.png",
                    format = 'png')

knitr::include_graphics("C:/Users/Myles/OneDrive/Documents/GitHubThings/ShotQualityResearch/viz/4.png")
```




```{r}
d2 %>%
  ggplot(aes(x = game_mov_mean_diff, y = mean_sq_ppp_diff)) + 
  geom_point() +
  ggimage::geom_image(aes(image = logo), size = 0.045, by = "width", asp = asp_ratio)


```

